ILeLo1lWjBk
https://www.youtube.com/watch?v=ILeLo1lWjBk
Unknown Category
This video is sponsored by Brilliant.org. More about them later. Hi there everyone. Today we're going to be talking about Betaflight's angle mode. And for those of you that fly both acro and angle mode, you'll know that Betaflight's acro mode is fantastic. It's a joy to fly. It's very responsive, it's very precise, and it's very stable in the air. And you might also know that Betaflight's angle mode is kind of none of those things. It's pretty wobbly, it's kind of imprecise, and it's very slow in comparison to acro mode. I noticed this while I was flying Tiny Whoops over Christmas, and I decided to put some time into figuring out what was going on with Betaflight's angle mode. And I think I've worked it out, and I'm excited to share that with you today. So in this video, we're going to be looking at the problems with angle mode that Betaflight has currently, and some of the solutions that we can implement to fix it. And at the end of the video, I'm going to be showing you how you can test those fixes for yourself, and enjoy a sneak peek of what Betaflight angle mode might be like in the future. It's a lot to cover in one video, so let's not waste any more time. Let's dive right into it. If you fly Betaflight angle mode, I'd love to know how you think it compares to acro mode and other firmwares like silverware. Please let me know what you think down in the comments. The first problem I noticed was one of speed and responsiveness in angle mode compared to acro. Let me show you some flight footage so you can see exactly what I mean. To make the comparison, let's start by looking at some sharp stick inputs in acro mode. And this is showing what Betaflight is capable of in terms of responsiveness. You can see that the quad is snapping left and right instantly in response to my stick inputs, and it's very precise as well. It's stopping dead at the end of each of the movements. If I switch to angle mode now, you can see that the character is totally different. The quad is much slower and much softer to respond, and a lot less precise. Each of the moves takes a lot longer, and I'm moving the sticks just as fast on the radio, it's just the quad is much slower to respond. If we switch back to acro again, immediately that snappy response is back. So there's a big gap in flight performance between acro and angle mode. So why is Betaflight's angle mode so much slower and less responsive than acro mode? Well, to explain, we're going to have to look in detail at how the Betaflight angle controller actually works. In the blue line, we have the stick input from your controller, which is the requested angle of the quad. And here it starts at centre, I move it over to the right hand side, and then back to centre again. The green line shows the angle the quad is actually at. And the way the angle mode controller works is it looks at the difference between the requested angle and the actual angle, multiplies that by a factor, and that creates the gyro setpoint, which tells the quad how fast to rotate towards the requested angle. So you might be able to see the problem here. Initially, we don't have much error between the requested angle and the actual angle of the quad. So nothing much happens, the quad doesn't start to rotate. Only once we have built up a lot of error, is there enough push to get the quad to rotate quickly towards the new angle. But things get worse because once my stick stops moving, the error starts to reduce again. And so the quad slows down and takes a really long time to reach the requested angle. This whole process takes hundreds of milliseconds. It's about 10 times as long as the typical latency of a video or controlling. So what can we do about angle mode being so slow? Well, it turns out that Betaflight had already solved this problem in acro mode. In acro mode, there's an extra term in the controller called feedforward that is designed to reduce this delay. And the way feedforward works is it looks at the movement of your sticks, how fast you're moving your sticks, and pushes the quad in that direction right away. So let's take a look at what this chart looks like if we add feedforward in. Here's the same chart with feedforward in the mix. You can see that immediately as we move the sticks, there's a big strong push here from feedforward, which gets the quad moving in the right direction right away before any error has built up. Once the stick stops moving, that feedforward push stops as well. But by that point, we have a lot less error and the quad is much closer to the requested angle than it was before. And so the end of the move finishes off nice and quickly. Overall, this is so much faster and more responsive than what we had without feedforward. I found that adding feedforward into angle mode made the biggest difference for me personally when flying tiny loops around indoors in tight spaces. The reduction in effective latency of tens or even hundreds of milliseconds from when you move the stick to when the quad responds in the air just allows you to avoid obstacles so much more easily and fly through tight gaps with a lot more precision. I think the tiny races in particular are going to get a lot of value out of this new feature and it's going to make them a lot faster around the track. One of the challenges we faced with adding feedforward is that it makes the quad very responsive to small stick inputs, which can make the quad feel a bit jittery, a bit on edge. Fortunately, Chris Thompson came up with a great fix for this, which is feedforward smoothing. So this spreads out the push of feedforward in time and makes it less responsive to small stick inputs. The result is that you can adjust the feedforward gain to get the push you need to make the quad nice and responsive in angle mode. And then separately, you can adjust the smoothing factor so that it doesn't feel too jittery and on edge in response to small stick inputs. But that wasn't the only issue that I identified with angle mode. The second issue is one of wobbliness. So let's take a look at what makes angle mode so wobbly in comparison to Acro. To show you what I mean, here's some flight footage in angle mode where I'm just making sharp your inputs. I'm not doing anything else, just sharp your inputs. And can you see how much the quad is wobbling around on pitch and roll as a result? That's really counterproductive for flying precisely in tight spaces. If you're enjoying this video so far, please hit the like button to help other people find it on YouTube. And if you haven't already, consider subscribing so you don't miss out on future videos. So what's going on here? What's causing that really bad wobble on sharp your moves? Well, I have here a little quad to show you what is happening. So here we have the quad and I'm just going to be flying forward so the quad is pitched forward like that, but absolutely flat, just pitched forward. Now I'm going to yaw the quad by 90 degrees. Can you see that now the quad is no longer pitched forward at all? It's rolled to the right. That yaw move has converted the pitch that we used to have into roll. Now, once that happens, the angle controller freaks out a bit and goes, I shouldn't have any roll. I should just have pitch. And so it then tries to correct to get the quad back on track. And that happens very slowly because it's all error-based and it creates a big wobble after the move. What's causing this problem and what can we do to fix it? Well, the problem is being caused by the fact we have two different coordinate systems at play here. The first is the angle mode coordinate system, which is earth referenced. And that means that the roll and the pitch axes are always level with the horizon and yaw is vertically up and down. We also have a control coordinate system, which is quad referenced. It moves with the quad. So the yaw axis for the control of the quad is always vertically up and down on the quad. And when the quad pitches forward, the yaw axis pitches forward. Whenever these two coordinate systems are not aligned, so whenever the quad coordinate system is not aligned with the angle mode coordinate system, we get error building up. And that causes wobbles in the video feed that you see. So how can we fix it? Well, again, we have to think and look at acro mode. When we're flying in acro mode, we automatically coordinate a little bit of roll in with our yaw turns to make sure that the quad stays nice and level through the yaw move. And this is exactly the same thing that we need to do in angle mode. Unfortunately, it's a little bit more difficult in angle mode. To coordinate a turn, we really need both the yaw and the roll sticks to be rates of rotation. And in angle mode, they're not. The yaw stick is a rate of rotation, but the roll stick is a requested angle. So we can't really coordinate the turn in the same way. Fortunately, we can write some code into the angle controller to coordinate the turn for us so that when we do a pure yaw move, the angle controller adds in just the right amount of roll for the quad to do a pure yaw move in the earth reference coordinate system. And when that happens, we don't see any error build up on pitch or roll during the fast yaw move. And if there's no error, there's no wobble. Let's look at some flight footage now to see how that affects the behavior of the quad. Here's some flight footage where we're doing sharp yaw moves as before, but the code in the angle controller is coordinating the turn for us. Sorry for the water on the lens. That's an occupational hazard of flying in the UK. We can see that the quad is much flatter on those yaw turns and it's not wobbling around after the yaw move anywhere near as much. One of the things that I really noticed when flying this yaw coordination code was how much less drift there was in the quad and how much more precise it was at flying tight lines. Before, when I was flying along and I yawed sharply, the quad would keep drifting in the direction that it was going in until the angle controller kind of sorted everything out and got it flying in the right direction, which took a few hundred milliseconds. With the yaw coordination code, when the quad's flying along and you yaw, there's no component of thrust in the direction you were going in. So the quad just flies straight forward with a lot less sideways drift. And that really does make it feel a lot more precise in my opinion. Now that we've talked through the problems with angle mode and how we've addressed them, I want to show you how you can test this code out for yourself and put it on your Tiny Whoops to fly around today. Before we start testing any new code, it's very important that we fully back up our configuration. So go into Betaflight Configurator, go into the CLI and type dump. That will dump out your entire config so that if you need to restore it later, you've got everything that you need. Make sure you save that to a file in a place where you'll remember it and call it something suitable. I'm calling this AOS 3.5 dump. Once you've got the dump, clear your output history and type diff. That will give you the difference between your configuration and Betaflight defaults. And save that to another file. Call that one something memorable as well. Once you've got those two files saved, if you have any issues and you want to go back to your old configuration, all you'll need to do is to reflash the same version of Betaflight that you currently have and then just paste in your dump, type save and hit enter. And that will completely restore your config to exactly what it is now. That's really important because you don't want to get into a situation where stuff isn't working and you can't get back to a good working configuration. So now that everything's backed up, let's go and try out the test code. Because this test code is based on Betaflight 4.4, you're going to need at least version 10.9 of the configurator. At the time of recording, that isn't released yet. So I'm going to be using a nightly build from this releases page and I'll put a link to it down in the video description. If when you're looking at this video, Betaflight Configurator 10.9 has been released, you can just use the release build. Once you have Betaflight Configurator 10.9, you're going to need to get hold of the test code. And the easiest way is to go to the PR, which is PR 12067. There'll be a link down in the video description. Scroll down and find the most recent do you want to test this code? Here you have an automated build comment. And inside there is going to be a bunch of assets and you can download them. Once you've downloaded the assets zip folder, you can just extract it. And inside, you'll find a whole bunch of hex files. And each of these is for a different target of Betaflight. What you'll need to know is exactly what chip your flight controller has. Does it have an F722? In which case, you'll use this F7X2 hex file. If you've got an F405, it will be the F405 hex file. You get the idea. You need to match the exact chip. So you need to know more than just is it an F4 or an F7. You need to know exactly what chip it is and then pick the right hex file from this list. Otherwise, it won't work. When you know exactly what hex file you need, you can jump into Update Firmware and then you're going to want to select your target. So I'm just going to hit Auto Detect and it will find the right target. You can see I've got an F745 here. So I'm going to be using the F745 hex file. Load firmware from your local drive and in this test code, you're going to select the right hex file. So for me, that's F745 and then hit Flash Firmware. If you have any problems during the flashing stage, I find the best thing to try first is ImpulseRC Driver Fixer because most of the time that's going to be the cause of the problem. I'll put a link to that down in the video description as well. Once you've flashed the firmware, you can hit Connect and you'll be asked if you want to apply custom defaults. Always select Yes. The flight controller will reboot and then you can hit Connect again and go back into the CLI. Now we're going to paste in the diff that we saved before. So we can load from file, select the diff, hit Execute and all of that will be executed. You may get some invalid names depending on whether you're updating from a different version of Betaflight. It's not usually a problem. You can type Save and then hit Enter. At this point, it's a good idea just to check through your config to make sure everything's set up as you want it. If everything looks good, you can jump to the CLI and type Get Angle and you should see Angle P Gain, Angle Feed Forward, Angle Feed Forward Smoothing and Angle Earth Ref as new settings which you can adjust. And for more information on tuning, I'll let you read the full PR 12067 and that will tell you what all of these terms do and how you should go about tuning them. I hope that those short instructions give you what you need to get started trying out these new features. If you're thinking of playing around with Betaflight test code, you should definitely know about the Betaflight Discord server. I'll put a link to that down in the video description. It's a great place to get help and support if you need it and also to leave your comments and feedback on these new features to help inform the further development of them. Now it's time for a word from our sponsor, Brilliant.org. If you're like me, the FPV hobby represents a fun and exciting way to apply maths, science and engineering skills. And whether you're a young professional looking to upskill as you grow into your career or you're someone who just loves finding new hobbies and exploring new ideas, Brilliant offers thousands of classes on maths, science and computer science with new ones being added every single month. If you're interested in computer science and maybe even looking forward to contributing to an open source project like Betaflight in the future, then courses like this on algorithm fundamentals are a great place to start building the skills that you'll need. To get started for free, visit brilliant.org slash ChrisRossa or click the link in the video description. The first 200 people to do so will also get 20% off an annual premium subscription with Brilliant so you can reach your learning goals and save a little bit of money at the same time. That's all I have for you for today. So until next time, I wish you all very, very happy flying.