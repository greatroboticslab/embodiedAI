WoxDbIbpP_Q
https://www.youtube.com/watch?v=WoxDbIbpP_Q
Unknown Category
Hi everyone, this is the second in my series of videos on Betaflight filter and PID tuning. In this video I'm going to take you through step by step everything you need to do and everything you need to know to get the perfect PID tune on any Betaflight quad. It's quite a lot of material to get through so let's not waste any time. I have to start this video with a little bit of a health warning. This video presumes that you are using my recommended filter tuning approach. Now I've done another video where I look at filter tuning in Betaflight. This video assumes that you've completed that video and that you've now got your filters correctly tuned. Don't proceed with this video until you've completed steps one to three in that other video. So the next steps are PID tuning and there are three steps here that we're going to cover in this video. Finding your max D gains that you're comfortable with. Then finding the right P to D balance in order to get a critically damped PID response. And then the final stage tuning feed forward for set point tracking so that we get really really great responsiveness of the quad, really close tracking of your stick inputs. Now in order to get a really good PID tune on your quadcopter it really helps if you understand all the different elements of Betaflight's PID controller and what they all do. Now Betaflight's PID controller consists of four main parts. P is the proportional term of the PID controller. I is the integral term of the PID controller. D is the derivative term of the PID controller. And feed forward is used to push the quad into sharp moves and improve set point tracking. Now don't worry if you don't understand all of these terms right away. We're going to go through them all step by step and explain how they all work now. So let's look at a diagram of Betaflight's PID controller. You can see that it takes two inputs. The first input is the input from the gyro which is telling the PID controller what the quad is doing at this instant. And then the second input is the set point. Now this is your stick positions multiplied by your rates. So it's what you are telling the quad you want it to do at that instant. And these two input terms are combined in this sum here. So the set point minus the gyro gives the PID error. So the PID error is the difference between what you told the quad you wanted it to do and what it is actually doing. And that PID error is fed into the derivative, proportional and integral terms. And they do some maths on it which we'll talk about in a second. And the results of those terms are all added together along with the feed forward term which is based only on the set point. They're all added together here. And this is where the PID gains that you set in beta flight are applied. So if you set a really big gain for the derivative term for example in this addition block here this gets multiplied by that gain. So if you double the derivative gain, the D gain, then it will add twice as much into this block as before. If you halve the proportional gain, suddenly this term only gets added half as much. So that's where all your PID gains live in this block here. Once all of those have been added together, that gives a control signal telling the quad how to change what it is doing. And that gets passed to the motor mixer. And the motor mixer determines, ah well if you want me to roll left more quickly, then I need to increase the speed of the right motors and decrease the speed of the left motors. So it turns the control signal that's telling the quad what to do into which motors do I speed up, which do I slow down. That's what the motor mixer does. So that is how the beta flight PID controller works in a very simple way. Now let's talk about the different terms. And we'll start with the proportional term because I think it's easiest to understand. Now the proportional term looks at the PID error. This blue line here represents zero PID error. So if we have some positive PID error, then the proportional term pushes back against that and tries to bring the PID error to zero. If that PID error gets bigger, the proportional term pushes harder. And if it's very big like this, you can see it's pushing really hard. If the PID error goes negative, then the proportional term still pushes back towards zero. So it's pushing back towards zero the whole time. And the bigger the PID error, the harder it pushes back. And so whatever size the PID error is, and whether it's positive or negative, that proportional term is just acting to try and reduce that PID error back towards that blue line, the zero line. Now let's talk about the derivative term. Now the derivative term is a little bit different. Because all the derivative term wants is for the PID error to stay the same from one minute to the next. It doesn't want it to be zero. It just wants it to stay the same. So if the PID error increases, the derivative term doesn't like that because it wants the PID error to stay the same. So it acts to try and stop the PID error increasing. But if the PID error starts to decrease, the derivative term doesn't like that either. It wants the PID error to stay the same. So it's pushing back against the PID error decreasing. So this is quite a strange behavior because you can see that things appear to be getting better here. The PID error is decreasing. But the derivative term just is pushing back. It wants the PID error to stay the same and not decrease. So that's how the derivative term works. The integral term also has a bit of a different behavior. The integral term adds up the PID error over time. So here we have some small positive PID error. And initially, the integral term pushes back a little bit. But then if that error doesn't go away, the integral term says, ah, I'll push back twice as hard. And then if there's another same amount of error again, three times as hard, four times as hard, five times as hard. It's adding up over time, that error. And the longer that error is there, the harder the integral term pushes back. But then what if the error goes negative? Well, the integral term then says, oh, okay, well, you've been negative for a bit. So I guess I don't need to push as hard. Oh, you're still negative. I'm going to push even less. Ah, still negative, even less. You can see it's adding up, but it's actually subtracting. It's taking a little bit away from its push every time it sees that negative PID error. So you can see the integral term is just counting. It's just adding up the error over time. And it's pushing back towards zero, but it's pushing back based on how much error has accumulated over time. And the feedforward term is completely different from the other terms in the PID controller, because it does not act on the PID error. It acts on the set point. And what it says is that if the set point is changing, I need to push the quad in the same direction to start it moving in the direction that the set point is changing. So if the set point is increasing, then the feedforward term pushes the quad to change in that direction. If the set point is decreasing, the feedforward term again pushes back to try and get the quad to move in the direction that the set point is moving in. Let's say you've just commanded full stick right roll. You're doing a snap roll to the right. The feedforward term sees that set point change and goes, ah, I need to start rolling right right now, because you've commanded a snap roll right. I need to start that move now. And it doesn't wait for the PID error to build up. It acts immediately. And this allows the feedforward term to really reduce the amount of PID error that builds up, because it gets the quad moving in the right direction straight away. There are three of these PID controllers in Betaflight, and they all work the same way. There's one each for roll, pitch and yaw axis, and they're all separate. The only difference with the yaw axis is that it doesn't have a derivative term, because the nature of the yaw axis for multirotors means that a derivative term isn't required. So with that said, let's jump into step four, finding your max D gains. Now the foundation, in my opinion, of a good PID tune is the right D gain. And the right D gain is as much as you feel comfortable that you can get away with. The more D gain you have, the hotter your motors are going to get, the more likely you are to get D term oscillations, especially if you bend a prop. However, the more D gain you can tolerate without getting motors that are too hot or D term oscillations, the better your final tune is going to be. Now, before tuning D term, make sure your build is in a representative state. So if you typically fly with bent props, make sure that you've got bent props on. If you typically fly a very clean build, make sure that that's how it's set up. If you usually fly with a GoPro, make sure that you've got a GoPro on the build. All of these things. Just make sure that your build is in the same state that you would normally fly it before you tune it. So we have these three boxes on the right. Now, if we start down here with too little D gain, we're going to have worse prop wash handling. We're going to have worse set point tracking. So the quad isn't going to follow the sticks as closely. We're going to have a bit of a flight feel, you know, not great. But the quad is going to be much more tolerant of vibrations. It's going to be more tolerant of damage, more tolerant of bent props, that sort of thing. If we have more D gain, we're going to have better prop wash handling, better set point tracking, that more responsive feel that we all want. And the quad is going to be overall less tolerant of vibration. So you're more likely to get hot motors and maybe even oscillations. If you damage the quad in flight, you bend a prop, something like that. And then at the top here, we have too much D gain. There's a real risk with too much D gain of overheating your motors, smoking motors and blowing ESCs. Getting flyaways, oscillations and overall sadness. So we definitely don't want too much D gain, but we also don't want too little. We want to try and aim for that maximum comfortable amount of D gain. So the amount of D gain that you want to run really depends on you as a pilot. And so I put together this little chart of trying to show what might be the right D gain for different kinds of pilots. So if you're a new pilot, you've got an unproven build, or you've got a build with known vibration issues, stick to stock D gains of about 30. This is for a five inch freestyle. If you are a bandeau basher and you know you're going to need to fly home after having a big crash, or perhaps you've got a build with rough motor bearings because you've had a big crash, then maybe stick with a D gain of about 35, a little bit more than stock. If you're an experienced pilot who builds nice clean quads, and you know that you rarely need to fly home from crashes, and more importantly, you know when you shouldn't fly home after a crash, you know when a prop is badly bent enough that you shouldn't fly at home, then perhaps you could tolerate a D gain of about 40. If you are a very experienced pilot with a very low vibration build, for example, an AOS 5 frame with PG44A mechanical damping grease applied to it, you've got your filters really dialed in, and you're the kind of pilot who goes, no, no, no, it's a lovely day and I'm going to go and walk and get my quad. I am not going to risk flying it back with a bent prop and smoking motors. And you're the kind of pilot who wants the best possible flight feel, that kind of fly-by telepathy responsiveness, then you might be able to tolerate even higher D gains, 45, 50, even 55. On my perfect AOS 5 build, I'm running D gains between 50 and 55. So it's doable, but you do need to have the right build and the right filter tune. Before starting, you need to unleash your PID controller. You need to enter the following into the Betaflight CLI to increase the PID sum limit to 100% of maximum. And what this allows the PID controller to do is to push even harder to try and follow setpoint. So these are the commands you need to enter. Set PID sum limit equals 1000, and hit enter. Set PID sum limit equals 1000, and hit enter. And then finally type save and hit enter. And that will save and reboot your flight controller and store those settings. So now that you know roughly what you might be aiming at in terms of D gains, you need a method to find your perfect D gains. And this is my method. There are other equally good methods. I know Mark Spatz at UAV Tech has another really good method, but this one's my one. So step one is to turn off D-Min. So go into the Betaflight PID tuning tab and turn off D-Min. The next step is to gradually turn up the master multiplier slider, 0.1 to 0.2 at a time. Every time you turn it up, do a tuning flight with some full throttle punch outs, some hard pylon turns, some aggressive flying, and come in and land and check for hot motors. And during the flight, listen for any kind of growling oscillations or any ticks or jerks from the motors. Repeat these steps, steps two to four, until you have a D gain that you're comfortable with. A D gain where you don't have motors that are too hot. So really if your motors feel hot to the touch, I would say that's too hot. If your motors feel just slightly warm to the touch, that's fine. And make sure that you don't have any ticks or oscillations. And if both of those things are true and you're comfortable with the amount of D gain you have, you've found your perfect D gains. I'd like to take a minute to try and explain why I prefer to use the master slider and not the P and D gain slider when I'm starting out tuning a quad. I think that for most five inch quads, the beta flight defaults have a really nice balance between the P, I and D terms. Using the master slider maintains that balance because all of the terms increase together, while it also increases the response to PID error, which is obviously what we're wanting to do. A really well tuned quad that follows setpoint closely and has iTerm Relax enabled, in my experience does not tend to suffer too badly with iTerm windup and associated overshooting. I also really like the way high i gains keep the quad very stable at speed, and I don't feel I get that same feel with the default level of i in beta flight. So on the AOS 5 for example with the master slider at 2.0, I have twice as much i gain as the default and I really like the way that feels. I know this is quite a personal thing, so I'd love to hear your thoughts in the comments. What are your experiences? How much i gain do you typically like to run? Once you've found your perfect D gain, which is the maximum D gain that you as a pilot are comfortable with, the next step, step five, is to find your P to D balance. The best way to do this is to look at logs using PID Toolbox. Don't worry if you've never used PID Toolbox before, I'm going to take you through it step by step. Before that you need to do some tuning flights with lots of full stick snap flips and rolls, and that's because that's what we're going to need to look at the step response. So let's look at an example step response here. Now this is the type of graph that we're going to see in PID Toolbox in a second. If your log looks like the green curve or the purple curve here that wiggle up and down for a while, that means you have too much P gain. And to fix that you're going to want to decrease your P gain. And the easiest way to do that in my opinion is to use the sliders. You increase the PD balance by one or two notches, and you reduce the PD gain by the exact same amount. And that's important because you want your D gain to stay the same and your P gain to reduce. If however you have a log that looks more like this purple line here where it's kind of very slow to reach the center, then you're going to want to increase your P gain. And you do that by doing the opposite. So you reduce the PD balance by 0.1 or 0.2, one or two notches. And you increase your PD gain by the exact same amount. So 0.1 or 0.2. But it's got to be the exact same amount you reduce the PD balance by. And the goal in my opinion is the red line here. You can see that there is just a tiny bit of overshoot, but there's no undershoot afterwards. That's the key. You see that brown line, it has an overshoot and then an undershoot. That's bad. We don't really want that. But that red line that just has a tiny overshoot, but gets up to the line as quickly as possible is exactly what we want. So that red line is what it should look like. I'm going to use this platform to make a request of the Betaflight developers now. I know Mark Spatz, UAV tech has made the same request. Please change the way the PD balance slider in Betaflight works. The goal with the tune is to keep D gain the same because you found your maximum D gain by now, and just change your P gain to get a critically damped response. To do this with the sliders currently, you need to move the PD balance and P and D gain in opposite directions by the exact same amount. If the PD balance slider was adjusted so that it altered the P gain rather than the D gain, you would only have one slider to move and it would be much simpler. So Betaflight devs, if you're listening, please, please, please change the PD balance slider to adjust P gain only and not D gain. Thanks very much. Okay, now the next sections of this video all require you to have black box logging enabled on your quad. Now I know that not everyone has black box logging on their quad because maybe they're flying an all-in-one board or something that doesn't have black box logging. If you do not have logging on your quad, you can still tune PD balance, which is what we're going to do next, by listening to the quad. But this can be quite tricky. What you're listening for is the motor zipping at the start and end of a snap flip or roll. So if everything is going well, when you do a snap roll, you'll hear zip, zip, and that first zip will be at the start of the move, and the second zip will be at the end of the move. Now decrease the PD balance by one tick and increase the PD gain by one tick and try again. Again, listen to the start and the end of the roll or flip. You should again hear zip, zip, two zips, one at the start of the move, one at the end of the move. Now if you keep going, if you keep decreasing your PD balance and increasing your PD gain, eventually you will start to hear a double zip at the start or more likely the end of the move. So you might hear something like this, zip, zip, zip. If you hear a double zip at the end of the move, that means that you've started to get bounce back overshoot. So you need to go back one. So what you want is to get to the lowest PD balance and highest PD gain, obviously moving them together, before you hear a double zip at the end of a move or the start of a move. Hopefully that's clear. If you've got any questions, please ask them in the comments. Once you've done that, set your stick response gain slider equal to your master multiplier that you found in the previous step. That should get you most of the way to a great tune. If you want to go all the way, you'll need logging and I'll put links to some inexpensive flight controllers with logging in the video description. So let's get set up with PID Toolbox. If you follow the link in the video description, you'll end up here on the PID Toolbox releases page in GitHub. You can see that the latest version at the time of this video is 0.42. If you scroll down, you'll see the various files here. You want the underscore win.zip if you're running Windows like I am. So download this folder here. See that's downloading. If we look at the folder, we can see that it's a zip folder. So we extract that with any tool and you can see that inside that extracted folder are two other folders. If this is the first time that you're running PID Toolbox, you will need to install the runtime. So let's go into the runtime installation file. You'll see there's just one file in here. Double click that, go through the installation process and then once that's finished, you can come out of that folder, go into the main folder. Now you'll see that there's a file called blackbox decode. Now this is the file that's needed to allow PID Toolbox to understand your blackbox log. So what we need to do here is select that, copy it, control c, come out of the folder again, go into our logs folder, mine is here, and just paste the blackbox decode in there. Obviously I've done that before so I replace, but that's the file that you need in order to decode the logs and it needs to be in the folder where your log files are. Okay, so it needs to be pasted in with all your logs as I've done here. Once you've done that, you can come out of your logs folder and go back into the PID Toolbox main folder and run PID Toolbox. That will open this window here, a kind of blank window. If you go over onto the right hand side, there's a green select button. So we click that and now we select the log file. So I'm just going to select this master 200 log here. I click OK. And if everything works, you should see some converting and importing status messages pop up and that will load in. Once that's loaded in, you should be able to see the log there on the screen. What we're going to be using for the next part of this video is the Step Response Tool. So that's again over on the right hand side. Click that blue button Step Response Tool. That opens this new blank window and just click the green run button. And that will produce the step response functions for that log. And that's where we're going to see if we have an underdamped, overdamped or critically damped system. Okay, so now you've seen exactly how to get a step response graph for your own log. Here's one that I did on the AOS 5. Now this is on the Betaflight default PD balance and all I've done in this log is turn the master slider up to 2.0. And you can see that the step response is pretty much perfect on roll and pitch. I'm very happy with these. I'm not going to change the PD balance at all from the Betaflight defaults on this build. It looks great. And you can see that your as well is a nice straight step up and then a flat line. So overall very happy with all three of these. And if your step response graphs look like this, then you're done. You don't need to make any adjustments to your PD balance at all. Now that we have our PIDs pretty much locked in, the next step, step six, is tuning feed forward. The first thing to do is to check that feed forward transition equals zero. Once that's been set, do a tuning flight with lots of full stick snap rolls and snap flips. We also need to install UAV text trace templates and open the log in Blackbox Explorer and look at the flips and rolls that we've done. Don't worry if you've never done this before. I'm going to take you through it again step by step. Okay, so let's get set up with Blackbox Explorer so that we can check our set point tracking from our logs. The first thing you'll need is Blackbox Explorer. So if you follow the link in the video description, you'll end up here to the releases page of the Blackbox Log Viewer, latest version 3.5 as of this video. You need the underscore win32 version .exe. You're on Windows, so just click that and download it. And once it's downloaded, run that file and it will install Blackbox Explorer for you. Once that's done, open Blackbox Explorer. And if you see this page when you open it, then you know that you've done the right thing and that everything's installed correctly. The next thing you need is UAV text Blackbox Explorer trace templates. So again, if you follow the link in the video description for the trace template, it'll take you to here. You can see that there are a few different versions. We want 3.5 version because that's the version of Blackbox Explorer that we have. So right click on that and download and that will download it. Then what we're going to do is we're going to open in Blackbox Explorer, go into the folder where we downloaded the trace template and simply select the trace template as a file that we want to open. And it will tell us that workspaces have been loaded and that's perfect. Then the next thing to do is to go into our logs folder. Again, just trying to open a log. Select a log in this case. I'm going to open master 200. Let's open and you can see that that's opened there and the log is, that whole log is here. Now, if we're wanting to look at stick tracking, we need to use a particular trace template. So go up here to workspace and select number four, stick tracking. So that's good. The next thing you'll want to do is turn off Expo in the display. So we go down here to Expo on off and turn it off. And that is all there is to it. Now you can scroll through the log to your heart's content and find the information that you want to look at. So here's, for example, a sharp roll one way and then the other. And I'm sure a little further on I've done something similar on pitch. Yeah, sharp pitch move forward and back. And a full throttle punch out. You can see the motors go up. So if you're seeing all of this, that means you have everything correctly configured. And now you can look at your stick tracking and let's see what you should be looking for in your stick tracking to show that you have a good tune for your feed forward. So now that you've got your traces open in Black Box Explorer, the next step is to show you what too little feed forward looks like. So you're probably going to start off with too little feed forward because the beta flight defaults are quite conservative. If you have too little feed forward, you'll see that the gyro line, which is this bluish purplish line here, lags behind the green line, which is a set point. And you can see it lags behind by quite a lot. It's always behind. And that's because we don't have enough feed forward. You'll also see if you look at the motors that the motors aren't really working that hard. They never really get up to 100% throttle. And so that means that the quad is kind of being lazy. It knows that it's not doing what you've told it to do because that blue line isn't on top of the green line, but it's not doing anything about it. It's just kind of lazing around with the motors at a modest amount of load. So that's what we need to fix. Now you might be tempted just to crank feed forward all the way up. If you do that, you might end up with too much feed forward. And it's really important to know what too much feed forward looks like. If we look at the start of this roll, you can see that everything looks really good. I mean, the gyro is right on top of the set point the whole way and everything looks great. But if we now look at the end of the roll, do you see how the gyro trace suddenly dips way below set point just here? That is because feed forward is too high and the quad is actually overshooting the end of the move. The other thing you'll notice is that now that we've got loads more feed forward, we've actually got motor saturation. So we're hitting 100% on the motor power for one motor. So the quad is working as hard as it possibly can to track set point. And you can see that the, even though the gyro is lagging behind the set point in this part of the move here, there's nothing we can do about that because a motor has reached 100%, it's saturated and there's nothing more to do. So if you have that situation where gyro and set point aren't on top of each other, but you have a motor at 100%, then there's nothing more you can do, I'm afraid. That's as good as it's going to get. Finally, let's look at what I settled on for my final feed forward value for the AOS 5. This is what I think is about the right amount of feed forward. So you'll notice that, you know, we're not quite tracking set point perfectly at the start of the move. There's possibly some more that I can do there to be fair. But for this rough tune, it's absolutely fine. And at the end of the move, there's no overshooting. You can see that the gyro doesn't really overshoot like it did in the last slide. So that's good too. There is just the hint of an overshoot here, which tells me that I can't increase feed forward anymore. Notice that we're still hitting motor saturation at the end of the move here. So there is enough feed forward to saturate the motors and have the quad working as hard as it can to stay on set point. And that's really what we want to see. We want to see that we have enough feed forward to make the motors max out on sharp moves. And then we know that we can do no more. The motors are doing all they can. If the quad can't track set point, that's just a mechanical limitation of the motors, the props, all of that kind of stuff. And we've done all we can in the PID controller. I hope you found this video interesting. You'll have noticed that we didn't make it to the end of my tuning process in this video. And that's because I have follow-up videos planned on how to tune your rates and how to fine tune your PIDs for the ultimate in flight performance. Make sure you're subscribed so you don't miss those videos when they're ready. If you like the work that I'm doing, please consider joining my Patreon. For less than $5 a month, you can get early access to the designs that I'm working on and have an opportunity to give feedback to make them even better. If you'd like the best possible platform to start your filter and PID tune from, please consider checking out my frame, the AOS 5. I'll put a link for that down in the video description as well. It's been designed from the ground up to give the absolute best possible vibration and resonance performance. And that's going to allow you to push your filters and PIDs further than ever before. That's all I have for you for today. So until next time, all that remains is for me to wish you all very, very happy flying.