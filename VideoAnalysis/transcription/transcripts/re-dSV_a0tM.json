{"video_id": "re-dSV_a0tM", "url": "https://www.youtube.com/watch?v=re-dSV_a0tM", "title": "re-dSV_a0tM", "category": "Unknown Category", "fps": null, "segments": [{"start": 0.0, "end": 3.96, "text": "Marvin, turn on the lights."}, {"start": 6.9, "end": 7.3, "text": "Okay."}, {"start": 8.3, "end": 11.02, "text": "Marvin, turn off the bedroom."}, {"start": 13.46, "end": 14.34, "text": "Okay."}, {"start": 15.0, "end": 17.48, "text": "Marvin, turn off the kitchen."}, {"start": 21.0, "end": 22.12, "text": "Okay."}, {"start": 22.56, "end": 25.04, "text": "Marvin, tell me a joke."}, {"start": 25.04, "end": 30.919999999999998, "text": "What goes up and down but does not move?"}, {"start": 32.339999999999996, "end": 32.9, "text": "Stairs."}, {"start": 34.6, "end": 37.22, "text": "Marvin, turn off the lights."}, {"start": 40.48, "end": 41.08, "text": "Okay."}, {"start": 42.4, "end": 42.96, "text": "Hey everyone."}, {"start": 43.9, "end": 49.120000000000005, "text": "So, if you've been playing along at home, you'll have known that we've been building towards something."}, {"start": 49.12, "end": 60.9, "text": "We've covered getting audio into the ESP32, getting audio out of the ESP32, and we've looked at getting some AI running using TensorFlow Lite."}, {"start": 61.86, "end": 65.62, "text": "This has all been building towards building an Alexa type system."}, {"start": 66.14, "end": 68.56, "text": "So what actually is an Alexa system?"}, {"start": 69.12, "end": 72.9, "text": "What components do we need to plug together to get something working?"}, {"start": 72.9, "end": 78.9, "text": "So, the first thing we're going to need is some kind of wake word detection system."}, {"start": 79.62, "end": 84.34, "text": "This will continuously listen to audio waiting for a trigger phrase or word."}, {"start": 85.14, "end": 93.06, "text": "When it hears this word, it will wake up the rest of the system and start recording audio to capture whatever instructions the user has."}, {"start": 94.18, "end": 98.42, "text": "Once the audio has been captured, it will send it off to a server to be recognised."}, {"start": 98.42, "end": 103.54, "text": "The server processes the audio and works out what the user is asking for."}, {"start": 104.26, "end": 108.42, "text": "The server may process the user's request and may trigger actions in other services."}, {"start": 108.98, "end": 114.02, "text": "In the system we're building, we'll just be using the server to work out what the user's intention was."}, {"start": 115.14, "end": 121.06, "text": "This intention is then sent back to the device and the device tries to perform what the user asked it to do."}, {"start": 122.1, "end": 123.62, "text": "So we need three components."}, {"start": 123.62, "end": 125.94, "text": "A wake word detection."}, {"start": 126.98, "end": 129.22, "text": "Audio capture and intent recognition."}, {"start": 129.94, "end": 131.54, "text": "And intent execution."}, {"start": 132.9, "end": 135.70000000000002, "text": "Let's start off with the wake word detection."}, {"start": 137.78, "end": 141.3, "text": "We're going to be using TensorFlow Lite for our wake word detection."}, {"start": 142.02, "end": 147.78, "text": "And as with any machine learning problem, our first port of call is to find some data to train against."}, {"start": 147.78, "end": 157.3, "text": "Now fortunately the good folk at Google have already done the heavy lifting for us and collated a speech commands dataset."}, {"start": 158.5, "end": 165.46, "text": "So this dataset contains over 100,000 audio files consisting of a set of 20 core command words such as"}, {"start": 166.02, "end": 171.86, "text": "up, down, left, right, yes, no and a set of extra words."}, {"start": 172.74, "end": 174.66, "text": "Each of the samples is one second long."}, {"start": 174.66, "end": 179.22, "text": "There's one word in particular that looks like a good candidate for a wake word."}, {"start": 179.85999999999999, "end": 183.22, "text": "I've chosen to use the word Marvin as my wake word."}, {"start": 183.22, "end": 186.82, "text": "Oh god, I'm so depressed."}, {"start": 187.62, "end": 189.54, "text": "Let's have a listen to a couple of the files."}, {"start": 189.54, "end": 190.98, "text": "Marvin"}, {"start": 190.98, "end": 193.78, "text": "Marvin"}, {"start": 193.78, "end": 195.46, "text": "Marvin"}, {"start": 195.46, "end": 197.62, "text": "Marvin"}, {"start": 197.62, "end": 199.62, "text": "Marvin"}, {"start": 199.62, "end": 200.5, "text": "Seven"}, {"start": 200.5, "end": 202.57999999999998, "text": "Seven"}, {"start": 202.57999999999998, "end": 204.5, "text": "Seven"}, {"start": 204.5, "end": 206.9, "text": "Seven"}, {"start": 206.9, "end": 212.74, "text": "I've also recorded a large sample of ambient background noise consisting of TV,"}, {"start": 213.3, "end": 216.02, "text": "radio shows and general office noise."}, {"start": 217.22, "end": 223.06, "text": "So now we've got our training data we need to work out what features to train our neural network against."}, {"start": 223.78, "end": 227.7, "text": "It's not likely that feeding in raw audio samples will give us a good result."}, {"start": 228.98, "end": 232.66, "text": "So reading around and looking at some TensorFlow samples"}, {"start": 232.66, "end": 238.12, "text": "A good approach seems to be to treat the problem as an image recognition problem."}, {"start": 238.12, "end": 242.46, "text": "We need to turn our audio samples into something that looks like an image."}, {"start": 242.46, "end": 247.12, "text": "To do this we can take a spectrogram of the audio sample."}, {"start": 247.12, "end": 252.38, "text": "To get a spectrum of an audio sample we break the sample into small sections."}, {"start": 252.38, "end": 257.1, "text": "We then perform a discrete Fourier transform on each of these sections."}, {"start": 257.1, "end": 262.0, "text": "This gives us the frequencies that are present in that slice of audio."}, {"start": 262.0, "end": 270.1, "text": "Putting these frequency slices together gives us a spectrogram of the sample."}, {"start": 270.1, "end": 275.0, "text": "Now I've created a Jupyter notebook to create the training data."}, {"start": 275.0, "end": 279.28, "text": "As always the first thing we do is import the libraries we're going to need and set up some"}, {"start": 279.28, "end": 280.28, "text": "constants."}, {"start": 280.28, "end": 284.92, "text": "We've got a list of words in our training data along with a dummy word for the background"}, {"start": 284.92, "end": 285.92, "text": "noise."}, {"start": 285.92, "end": 291.68, "text": "I've made some helper functions for getting all the files for a word and also for detecting"}, {"start": 291.68, "end": 294.64, "text": "if the file actually contains voice data."}, {"start": 294.64, "end": 299.74, "text": "Some of the samples are not exactly one second long and some of them have truncated audio"}, {"start": 299.74, "end": 301.72, "text": "data."}, {"start": 301.72, "end": 306.46000000000004, "text": "We then have our function for generating the spectrogram for an audio sample."}, {"start": 306.46000000000004, "end": 312.48, "text": "We first make sure the audio sample is normalised and then we compute the spectrogram."}, {"start": 312.48, "end": 316.6, "text": "We reduce the result of this by applying average pooling."}, {"start": 316.6, "end": 321.42, "text": "We finally take a log of the spectrogram so that we don't feed extreme values into our"}, {"start": 321.42, "end": 325.36, "text": "neural network which might make it harder to train."}, {"start": 325.36, "end": 330.58000000000004, "text": "For each file we collect training data from we apply some random modifications."}, {"start": 330.58000000000004, "end": 334.70000000000005, "text": "We randomly shift the audio sample in its one second segment."}, {"start": 334.70000000000005, "end": 339.38, "text": "This makes sure that our neural network generalises around the audio position."}, {"start": 339.38, "end": 343.54, "text": "We also add in some random sample of background noise."}, {"start": 343.54, "end": 348.48, "text": "This helps our neural network work out the unique features of our target word and ignore"}, {"start": 348.48, "end": 351.78, "text": "any background noise."}, {"start": 351.78, "end": 356.68, "text": "Now we need to add more samples of the Marvin word to our dataset as it would otherwise be"}, {"start": 356.68, "end": 359.88, "text": "swamped by the other words in our training data."}, {"start": 359.88, "end": 362.38, "text": "So we repeat it multiple times."}, {"start": 362.38, "end": 366.65999999999997, "text": "This also helps our neural network generalise as there will be multiple samples of the word"}, {"start": 366.66, "end": 373.24, "text": "different background noise and in different positions in the one second sample."}, {"start": 373.24, "end": 376.04, "text": "We then add in samples from our background noise."}, {"start": 376.04, "end": 381.08000000000004, "text": "We run through each file of background noise and chop it into one second segments."}, {"start": 381.08000000000004, "end": 385.78000000000003, "text": "And then we also generate some random utterances from our background noise."}, {"start": 385.78000000000003, "end": 392.46000000000004, "text": "Once again this should help our network distinguish between the word Marvin and random noises."}, {"start": 392.46000000000004, "end": 396.58000000000004, "text": "Now during my testing of the system I found that there were some particular noises that"}, {"start": 396.58, "end": 399.78, "text": "seem to trigger false detection of the word Marvin."}, {"start": 399.78, "end": 405.09999999999997, "text": "These seem to consist of low frequency humming and strange scraping sounds."}, {"start": 405.09999999999997, "end": 411.41999999999996, "text": "So I've collected some of these sounds as more negative samples for the training process."}, {"start": 411.41999999999996, "end": 417.34, "text": "With all this data we end up with a reasonably sized training validation and testing dataset."}, {"start": 417.34, "end": 421.34, "text": "So we can save this to disk for use in our training workbook."}, {"start": 421.34, "end": 425.74, "text": "We can also have a look at the spectrograms for different words in our training data."}, {"start": 425.74, "end": 429.94, "text": "So here's some examples of Marvin."}, {"start": 429.94, "end": 434.28000000000003, "text": "And here's some examples of the word yes."}, {"start": 434.28000000000003, "end": 436.84000000000003, "text": "So that's our training data prepared."}, {"start": 436.84000000000003, "end": 440.94, "text": "Let's have a look at how we train our model up."}, {"start": 440.94, "end": 444.94, "text": "I've created another Jupyter notebook for training our model."}, {"start": 444.94, "end": 448.14, "text": "Once again we have to pull in the imports we need."}, {"start": 448.14, "end": 453.46, "text": "We also set up TensorBoard so that we can visualise the training of our model."}, {"start": 453.46, "end": 455.46, "text": "We've got our list of words."}, {"start": 455.46, "end": 460.14, "text": "It's important that this is in the same order as in the training workbook."}, {"start": 460.14, "end": 463.14, "text": "And we have the code to load up our training data."}, {"start": 463.14, "end": 470.91999999999996, "text": "If we plot a histogram of the training data you can see that we have a lot of examples"}, {"start": 470.91999999999996, "end": 476.96, "text": "of the word at position 16 and quite a few at position 35."}, {"start": 476.96, "end": 482.21999999999997, "text": "Combining this with our words we can see that this matches up to the word Marvin and to our"}, {"start": 482.21999999999997, "end": 483.34, "text": "background noise."}, {"start": 483.34, "end": 489.59999999999997, "text": "Now for our system we only really care about detecting the word Marvin so we'll modify"}, {"start": 489.59999999999997, "end": 496.02, "text": "our y labels so that it contains a 1 for Marvin and a 0 for everything else."}, {"start": 496.02, "end": 500.02, "text": "Plotting another histogram we can see that we now have a fairly balanced set of training"}, {"start": 500.02, "end": 504.26, "text": "data with examples of our positive and negative classes."}, {"start": 504.26, "end": 509.26, "text": "We can now feed our data into TensorFlow datasets."}, {"start": 509.26, "end": 517.92, "text": "We set up our training data to repeat forever, randomly shuffle and to come out in batches."}, {"start": 517.92, "end": 519.58, "text": "Now we create our model."}, {"start": 519.58, "end": 524.26, "text": "I've played around with a few different model architectures and ended up with this as a trade-off"}, {"start": 524.26, "end": 528.68, "text": "between time to train, accuracy and model size."}, {"start": 528.68, "end": 533.68, "text": "We have a convolution layer followed by a max pooling layer."}, {"start": 533.68, "end": 537.2399999999999, "text": "We have a convolution layer followed by another convolution layer with a max pooling layer"}, {"start": 537.2399999999999, "end": 544.9599999999999, "text": "and the result of this is fed into a densely connected layer and finally to our output neuron."}, {"start": 544.9599999999999, "end": 549.4, "text": "Looking at the summary of our model we can see how many parameters it has."}, {"start": 549.4, "end": 554.3399999999999, "text": "This gives us a fairly good indication of how large the model will be when we convert it"}, {"start": 554.3399999999999, "end": 556.18, "text": "to TensorFlow Lite."}, {"start": 556.18, "end": 562.68, "text": "Finally, we compile our model, set up the tensorboard logging and kick off the training."}, {"start": 562.68, "end": 571.2399999999999, "text": "With our training completed we can now take a look at how well it has performed."}, {"start": 571.2399999999999, "end": 575.14, "text": "Looking at the tensorboard we can see that our training performance is pretty close to"}, {"start": 575.14, "end": 576.2399999999999, "text": "our validation performance."}, {"start": 576.2399999999999, "end": 579.7399999999999, "text": "There is a bit of noise on the unsmoothed lines."}, {"start": 579.7399999999999, "end": 585.1999999999999, "text": "Ideally we should probably try and increase the size of our training and validation data."}, {"start": 585.1999999999999, "end": 587.68, "text": "Let's see how well it does on the testing dataset."}, {"start": 587.68, "end": 593.76, "text": "I'm going to use the best model that was found during training and work from that."}, {"start": 593.76, "end": 596.2399999999999, "text": "You can see that we get pretty good results."}, {"start": 596.2399999999999, "end": 601.4799999999999, "text": "Checking the confusion matrix we can see how many false positives and how many false negatives"}, {"start": 601.4799999999999, "end": 602.4799999999999, "text": "we get."}, {"start": 602.4799999999999, "end": 604.68, "text": "These are pretty good results as well."}, {"start": 604.68, "end": 609.56, "text": "I would rather get more false positives than false negatives as we don't want to be randomly"}, {"start": 609.56, "end": 611.68, "text": "waking up from background noises."}, {"start": 611.68, "end": 616.4399999999999, "text": "Let's try it with a higher threshold and see how that performs."}, {"start": 616.4399999999999, "end": 619.28, "text": "This is probably what we will go for in our code."}, {"start": 619.28, "end": 625.3399999999999, "text": "We will get a lot more false negatives but also far fewer false positives."}, {"start": 625.3399999999999, "end": 631.4799999999999, "text": "So as we don't seem to be overfitting I am happy to train the model on our complete dataset."}, {"start": 631.48, "end": 644.38, "text": "We will get a lot of training, validation and testing all combined into one large dataset."}, {"start": 644.38, "end": 647.64, "text": "Let's see how this performs on all our data."}, {"start": 647.64, "end": 650.3000000000001, "text": "Once again we have pretty good results."}, {"start": 650.3000000000001, "end": 657.02, "text": "Our next step is to convert the model to TensorFlow Lite for use on the ESP32."}, {"start": 657.02, "end": 660.9, "text": "So let's jump into another workbook for this."}, {"start": 660.9, "end": 663.86, "text": "We have our imports to bring in TensorFlow and NumPy."}, {"start": 663.86, "end": 666.98, "text": "We are also going to need our data."}, {"start": 666.98, "end": 672.4399999999999, "text": "We need this so that the converter can quantize our model accurately."}, {"start": 672.4399999999999, "end": 677.02, "text": "Once the model has been converted we can run a command line tool to generate the C code."}, {"start": 677.02, "end": 681.06, "text": "We can now compile that into our project."}, {"start": 681.06, "end": 686.38, "text": "We'll take a look at the wake word detection code on the ESP side of things later."}, {"start": 686.38, "end": 689.38, "text": "Next we need to get to another building block."}, {"start": 689.38, "end": 694.04, "text": "Once we've detected the wake word we need to record some audio and work out what the user"}, {"start": 694.04, "end": 695.22, "text": "wants us to do."}, {"start": 695.22, "end": 701.9, "text": "We're going to need something that can understand speech."}, {"start": 701.9, "end": 707.58, "text": "So to do the heavy lifting of actually recognising the text we're going to be using a service"}, {"start": 707.58, "end": 711.22, "text": "from Facebook called Wit AI."}, {"start": 711.22, "end": 718.48, "text": "So this is a free service that will analyse speech and work out what the intention is behind"}, {"start": 718.48, "end": 719.86, "text": "the speech."}, {"start": 719.86, "end": 727.1600000000001, "text": "So we'll log in using Facebook."}, {"start": 727.16, "end": 732.16, "text": "And then the first thing we need to do is create a new application."}, {"start": 732.16, "end": 737.78, "text": "So let's just call this marty1."}, {"start": 737.78, "end": 740.3399999999999, "text": "We'll make it private for now."}, {"start": 740.3399999999999, "end": 741.78, "text": "And we'll create."}, {"start": 741.78, "end": 750.0799999999999, "text": "So now we need to train our application to work out what it is we're trying to do."}, {"start": 750.08, "end": 752.94, "text": "So let's add a few sample phrases."}, {"start": 752.94, "end": 759.86, "text": "So let's try turning something on."}, {"start": 759.86, "end": 769.14, "text": "So we need to create an intent."}, {"start": 769.14, "end": 773.72, "text": "And then we need to start highlighting some of the bits of text."}, {"start": 773.72, "end": 778.28, "text": "So let's try and pull out the device that we're trying to turn on."}, {"start": 778.28, "end": 781.5600000000001, "text": "So I'll create an entity."}, {"start": 781.5600000000001, "end": 784.2, "text": "So now we have an entity called device."}, {"start": 784.2, "end": 790.1600000000001, "text": "And we've highlighted bedroom as the piece of text that should correspond to that device."}, {"start": 790.1600000000001, "end": 793.4, "text": "And now we can add a trait for on and off."}, {"start": 793.4, "end": 797.64, "text": "So this is a built-in trait that's supplied by Wit."}, {"start": 797.64, "end": 801.1800000000001, "text": "And we want to say that this should be turned on."}, {"start": 801.18, "end": 804.9399999999999, "text": "So let's train this."}, {"start": 804.9399999999999, "end": 811.3599999999999, "text": "And now let's try adding another piece of text."}, {"start": 811.3599999999999, "end": 817.54, "text": "So you can see that it's worked out the device already."}, {"start": 817.54, "end": 820.28, "text": "And it's worked out the value should be off."}, {"start": 820.28, "end": 827.74, "text": "So let's add that to our turn off and on intent."}, {"start": 827.74, "end": 829.8599999999999, "text": "Let's try adding another one."}, {"start": 829.86, "end": 834.3000000000001, "text": "So let's try turn on the kitchen."}, {"start": 834.3000000000001, "end": 837.36, "text": "So it's worked out that it's an on-off trait."}, {"start": 837.36, "end": 839.48, "text": "And it's worked out on."}, {"start": 839.48, "end": 843.04, "text": "And then let's highlight this and tell it that's the device."}, {"start": 843.04, "end": 845.74, "text": "And we'll train that as well."}, {"start": 845.74, "end": 850.86, "text": "So let's try another one."}, {"start": 850.86, "end": 852.86, "text": "Turn off the kitchen."}, {"start": 852.86, "end": 856.3000000000001, "text": "So it's improved its understanding."}, {"start": 856.3000000000001, "end": 860.36, "text": "Now it can see the device is kitchen and the trait is off."}, {"start": 860.36, "end": 862.36, "text": "So let's try and validate that."}, {"start": 862.36, "end": 868.3000000000001, "text": "Now you can keep adding more utterances to improve the performance of your application."}, {"start": 868.3, "end": 872.74, "text": "But I think for now that should be enough for our use case."}, {"start": 872.74, "end": 877.1800000000001, "text": "So let's try this out with some real text."}, {"start": 877.18, "end": 883.68, "text": "So I've made some sample utterances and recorded them to WAV files."}, {"start": 883.68, "end": 889.12, "text": "So I have a turn off, a turn on, and another example turn on."}, {"start": 889.12, "end": 892.12, "text": "So let's have a quick listen to these files."}, {"start": 892.12, "end": 894.12, "text": "So turn off."}, {"start": 894.12, "end": 896.12, "text": "Turn off the bedroom."}, {"start": 896.12, "end": 899.86, "text": "So hopefully that should turn off the bedroom."}, {"start": 899.86, "end": 903.9, "text": "So let's try running this through wit."}, {"start": 903.9, "end": 915.94, "text": "So I have a curl command here that will post up the WAV file to the backend service."}, {"start": 915.94, "end": 921.46, "text": "So you can see it's detected that the device is bedroom."}, {"start": 921.46, "end": 924.5600000000001, "text": "And it's detected that we want to turn off the bedroom."}, {"start": 924.56, "end": 926.7399999999999, "text": "So let's try another one."}, {"start": 926.7399999999999, "end": 931.68, "text": "So we'll try turn on."}, {"start": 931.68, "end": 934.5, "text": "Turn on the light."}, {"start": 934.5, "end": 937.5999999999999, "text": "So this should turn on the light."}, {"start": 937.5999999999999, "end": 939.9, "text": "So let's try that."}, {"start": 939.9, "end": 946.8199999999999, "text": "So we can see once again it's detected the device."}, {"start": 946.8199999999999, "end": 950.0799999999999, "text": "It tells us that it's the light."}, {"start": 950.0799999999999, "end": 952.8, "text": "It's found the intent, turn on device."}, {"start": 952.8, "end": 954.8, "text": "But it says we want to turn it on."}, {"start": 954.8, "end": 958.42, "text": "So let's try our last sample."}, {"start": 958.42, "end": 959.92, "text": "So turn on two."}, {"start": 959.92, "end": 963.9599999999999, "text": "Turn on bedroom."}, {"start": 963.9599999999999, "end": 966.3599999999999, "text": "So this should turn on the bedroom as well."}, {"start": 966.3599999999999, "end": 967.8, "text": "So let's check that works."}, {"start": 967.8, "end": 968.8, "text": "So yeah."}, {"start": 968.8, "end": 980.3, "text": "So it's found the device and it's worked out."}, {"start": 980.3, "end": 981.92, "text": "We want to turn it on."}, {"start": 981.92, "end": 986.0799999999999, "text": "So I think this wit application should work for us."}, {"start": 986.0799999999999, "end": 989.5, "text": "So let's integrate it into our code."}, {"start": 989.5, "end": 995.02, "text": "So that's our building blocks completed."}, {"start": 995.02, "end": 997.12, "text": "We have something that will detect a wake word."}, {"start": 997.12, "end": 1002.06, "text": "And we have something that will work out what the user's intention was."}, {"start": 1002.06, "end": 1007.5, "text": "Let's have a look at how this is all wired up on the ESP32 side of things."}, {"start": 1007.5, "end": 1012.3, "text": "I've created a set of libraries for the main components of the project."}, {"start": 1012.3, "end": 1018.58, "text": "We have the TFMicro library which includes everything needed to run a TensorFlow Lite model."}, {"start": 1018.58, "end": 1022.5, "text": "And we have a wrapper library to make it slightly easier to use."}, {"start": 1022.5, "end": 1026.28, "text": "Here's our trained model converted into C code."}, {"start": 1026.28, "end": 1029.62, "text": "And here are the functions that we'll use to communicate with it."}, {"start": 1029.62, "end": 1035.6599999999999, "text": "We have one to get the input buffer and another to run a prediction on the input data."}, {"start": 1035.6599999999999, "end": 1042.6999999999998, "text": "We've covered this in more detail in a previous video so I won't go into too many details on this now."}, {"start": 1042.6999999999998, "end": 1048.4399999999998, "text": "Moving on, we have a couple of helper libraries for getting audio in and out of the system."}, {"start": 1048.4399999999998, "end": 1057.52, "text": "We can support both I2S microphones directly and analogue microphones using the analogue to digital converter."}, {"start": 1057.52, "end": 1065.52, "text": "Samples from the microphone are heading to a circular buffer with room for just over 1 seconds worth of audio."}, {"start": 1065.52, "end": 1073.28, "text": "Our audio output library supports playing WAV files from SPIFs via an I2S amplifier."}, {"start": 1073.28, "end": 1076.42, "text": "We've then got our audio processing code."}, {"start": 1076.42, "end": 1081.3, "text": "This needs to recreate the same process that we used for our training data."}, {"start": 1081.3, "end": 1085.74, "text": "The first thing we need to do is work out the mean and max values of the samples so that"}, {"start": 1085.74, "end": 1088.36, "text": "we can normalise the audio."}, {"start": 1088.36, "end": 1094.98, "text": "We then step through the 1 second of audio, extracting a window of samples on each step."}, {"start": 1094.98, "end": 1100.42, "text": "The input samples are normalised and copied into our FFT input buffer."}, {"start": 1100.42, "end": 1107.88, "text": "Now the input to the FFT is a power of 2 so there is a blank area that we need to zero out."}, {"start": 1107.88, "end": 1113.26, "text": "Before performing the FFT we apply a hamming window and then once we have done the FFT we"}, {"start": 1113.26, "end": 1116.78, "text": "extract the energy in each frequency bin."}, {"start": 1116.78, "end": 1124.14, "text": "We follow that by the same average pooling process as in training and then finally we take the log."}, {"start": 1124.14, "end": 1130.8799999999999, "text": "This gives us the set of features that our neural network is expecting to see."}, {"start": 1130.8799999999999, "end": 1134.56, "text": "Finally we have the code for talking to WIT AI."}, {"start": 1134.56, "end": 1139.8799999999999, "text": "To avoid having to buffer the entire audio sample in memory we need to perform a chunked upload"}, {"start": 1139.88, "end": 1141.98, "text": "of the data."}, {"start": 1141.98, "end": 1146.7, "text": "We create a connection to WIT AI and then upload the chunks of data until we have collected"}, {"start": 1146.7, "end": 1150.5800000000002, "text": "sufficient audio to capture the user's command."}, {"start": 1150.5800000000002, "end": 1155.48, "text": "We decode the results from WIT AI and extract the pieces of information that we are interested"}, {"start": 1155.48, "end": 1156.48, "text": "in."}, {"start": 1156.48, "end": 1162.0600000000002, "text": "We only care about the intent, the device and whether the user wants to turn the device"}, {"start": 1162.0600000000002, "end": 1163.44, "text": "on or off."}, {"start": 1163.44, "end": 1167.66, "text": "That's all the components of our application."}, {"start": 1167.66, "end": 1170.4, "text": "Let's see how these are all coordinated."}, {"start": 1170.4, "end": 1175.3200000000002, "text": "In our setup function we do all the normal work of setting up the serial port, connecting"}, {"start": 1175.3200000000002, "end": 1179.3, "text": "to WiFi and starting up SPFs."}, {"start": 1179.3, "end": 1185.92, "text": "We configure the audio input and the audio output and we set up some devices and map them onto GPIO"}, {"start": 1185.92, "end": 1187.46, "text": "ports."}, {"start": 1187.46, "end": 1192.74, "text": "Finally we create a task that will delegate onto our application class before we kick"}, {"start": 1192.74, "end": 1196.14, "text": "off the audio input."}, {"start": 1196.14, "end": 1201.18, "text": "Our application task is woken up every time the audio input fills up one of the sections"}, {"start": 1201.18, "end": 1202.82, "text": "of the ring buffer."}, {"start": 1202.82, "end": 1208.24, "text": "Every time that happens it services the application."}, {"start": 1208.24, "end": 1211.52, "text": "Our application consists of a very simple state machine."}, {"start": 1211.52, "end": 1213.48, "text": "We can be in one of two states."}, {"start": 1213.48, "end": 1219.88, "text": "We can either be waiting for the wake word or we can be recognising a command."}, {"start": 1219.88, "end": 1223.46, "text": "Let's have a look at the detect wake word state."}, {"start": 1223.46, "end": 1227.2, "text": "The first thing we do is get hold of the ring buffer."}, {"start": 1227.2, "end": 1232.92, "text": "We rewind by one seconds worth of samples and then generate the spectrogram."}, {"start": 1232.92, "end": 1237.6200000000001, "text": "This spectrogram is fed directly into the neural network's input buffer so we can run the"}, {"start": 1237.6200000000001, "end": 1239.6, "text": "prediction."}, {"start": 1239.6, "end": 1243.9399999999998, "text": "If the neural network thinks the wake word occurred then we move onto the next state."}, {"start": 1243.9399999999998, "end": 1248.56, "text": "Otherwise we stay in the current state."}, {"start": 1248.56, "end": 1250.9599999999998, "text": "For the command recognition state."}, {"start": 1250.9599999999998, "end": 1254.84, "text": "When we enter the state we make a connection to witai."}, {"start": 1254.84, "end": 1262.3999999999999, "text": "This can take up to 1.5 seconds as making an SSL connection on the ESP32 is quite slow."}, {"start": 1262.3999999999999, "end": 1265.1799999999998, "text": "We then start streaming samples to the server."}, {"start": 1265.18, "end": 1269.6000000000001, "text": "To allow for the SSL connection time we go back one second into the past so we don't miss"}, {"start": 1269.6000000000001, "end": 1272.72, "text": "too much of what the user said."}, {"start": 1272.72, "end": 1278.88, "text": "Once we streamed 3 seconds of samples we ask witai what the user said."}, {"start": 1278.88, "end": 1284.0800000000002, "text": "We could be more clever here and we could wait until we think the user has stopped speaking"}, {"start": 1284.0800000000002, "end": 1287.8400000000001, "text": "but that's probably work for a future version."}, {"start": 1287.8400000000001, "end": 1292.6200000000001, "text": "Witai processes the audio and tells us what the user asked."}, {"start": 1292.62, "end": 1298.3, "text": "We pass that onto our intent processor to interpret the request and move onto the next state which"}, {"start": 1298.3, "end": 1302.8999999999999, "text": "will put us back into waiting for the wake word."}, {"start": 1302.8999999999999, "end": 1308.9599999999998, "text": "Our intent processor simply looks at the intent name that witai provides us and carries out"}, {"start": 1308.9599999999998, "end": 1311.62, "text": "the appropriate action."}, {"start": 1311.62, "end": 1312.62, "text": "the user's intent to interpret the request and the user's intent."}, {"start": 1312.62, "end": 1316.62, "text": "Marvin, tell me about life."}, {"start": 1316.62, "end": 1317.62, "text": "LIFE."}, {"start": 1317.62, "end": 1318.62, "text": "Don't talk to me about LIFE."}, {"start": 1318.62, "end": 1320.62, "text": "So there we have it."}, {"start": 1320.62, "end": 1325.62, "text": "A DIY Alexa."}, {"start": 1325.62, "end": 1330.62, "text": "How well does it actually work?"}, {"start": 1330.62, "end": 1333.62, "text": "It works reasonably well."}, {"start": 1333.62, "end": 1337.9599999999998, "text": "We have a very lightweight wake word detection system."}, {"start": 1337.9599999999998, "end": 1344.54, "text": "It runs in around 100ms and there's still room for lots of optimisation."}, {"start": 1344.54, "end": 1346.8999999999999, "text": "Accuracy on the wake word is ok."}, {"start": 1346.8999999999999, "end": 1350.6, "text": "We do need more training data to make it really robust."}, {"start": 1350.6, "end": 1356.78, "text": "You can easily trick it into activating by using similar words to Marvin such as marvellous,"}, {"start": 1356.78, "end": 1359.3799999999999, "text": "Martin, Marlin."}, {"start": 1359.3799999999999, "end": 1363.74, "text": "More negative examples of words would help with this problem."}, {"start": 1363.74, "end": 1369.28, "text": "The witai system works very well and you can easily add your own intents and traits and"}, {"start": 1369.28, "end": 1370.8799999999999, "text": "build a very powerful system."}, {"start": 1370.88, "end": 1376.6200000000001, "text": "There are also alternative paid versions which you can use instead."}, {"start": 1376.6200000000001, "end": 1383.3400000000001, "text": "One is available from Microsoft and Google and Amazon also have similar and equivalent services."}, {"start": 1383.3400000000001, "end": 1385.1000000000001, "text": "All the code is in GitHub."}, {"start": 1385.1000000000001, "end": 1387.38, "text": "The link is in the description."}, {"start": 1387.38, "end": 1393.5200000000002, "text": "All you actually need is a microphone to get audio data into the ESP32."}, {"start": 1393.5200000000002, "end": 1395.24, "text": "You don't necessarily need a speaker."}, {"start": 1395.24, "end": 1400.16, "text": "You can just comment out the sections that try and talk to you."}, {"start": 1400.16, "end": 1412.2, "text": "Let me know how you get on in the comments section."}, {"start": 1430.16, "end": 1433.22, "text": "that you are typing shows a 81 that it would also be making some very smart fellow"}, {"start": 1433.22, "end": 1434.1000000000001, "text": "Casting it to the AVadads."}, {"start": 1434.1000000000001, "end": 1434.74, "text": "If you had that sensitivity around,aremisation is a good score."}, {"start": 1434.74, "end": 1438.96, "text": "I'm always sad that you can do längers with your neon head, which are completely incredible."}, {"start": 1438.96, "end": 1440.78, "text": "You should know how to check out the effects and the other things that have displayed all."}, {"start": 1440.78, "end": 1441.8600000000001, "text": "Lots of things they make different."}, {"start": 1441.8600000000001, "end": 1444.42, "text": "When you are goog Old and intents andendo and learning, learn about which Phi."}, {"start": 1444.42, "end": 1447.5600000000002, "text": "The most experimental應 ARgs are not medio how you can use some estuv Casey."}, {"start": 1447.5600000000002, "end": 1454.48, "text": "That skill"}, {"start": 1454.48, "end": 1455.22, "text": "is particularly really important to you."}]}